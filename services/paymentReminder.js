require('dotenv').config();
const mongoose = require('mongoose');
const nodemailer = require('nodemailer');
const schedule = require('node-schedule');

// Database Connection
mongoose.connect(process.env.MONGO_URI, { useNewUrlParser: true, useUnifiedTopology: true })
  .then(() => console.log('MongoDB connected successfully.'))
  .catch(err => {
    console.error('MongoDB connection error:', err);
    process.exit(1); // Exit the application if database connection fails
  });

// Models (Example Schemas)
const Payment = mongoose.model('Payment', new mongoose.Schema({
  status: String,
  invoiceId: { type: mongoose.Schema.Types.ObjectId, ref: 'Invoice' },
}));

const Invoice = mongoose.model('Invoice', new mongoose.Schema({
  customer: { type: mongoose.Schema.Types.ObjectId, ref: 'Customer' },
  invoiceNumber: String,
  dueDate: Date,
}));

const Customer = mongoose.model('Customer', new mongoose.Schema({
  email: String,
  name: String,
}));

// Email Configuration
const transporter = nodemailer.createTransport({
    service: 'Gmail',
    auth: {
      user: process.env.EMAIL_USER,
      pass: process.env.EMAIL_PASSWORD,
    },
  });
  

// Function to send reminder emails
const sendReminderEmail = async (email, invoiceNumber, dueDate, customerName) => {
  try {
    const mailOptions = {
      from: process.env.EMAIL_USER,
      to: email,
      subject: `Payment Reminder: Invoice #${invoiceNumber}`,
      text: `Dear ${customerName},\n\nThis is a friendly reminder that your payment for Invoice #${invoiceNumber} is due on ${dueDate.toDateString()}.\n\nPlease ensure payment is made before the due date.\n\nThank you.`,
    };

    await transporter.sendMail(mailOptions);
  } catch (error) {
    console.error(`Failed to send reminder email to ${email}:`, error);
  }
};

// Function to find pending payments and send reminders
const sendPendingPaymentReminders = async () => {
    try {
      const pendingPayments = await Payment.find({ status: 'pending' }).populate({
        path: 'invoiceId',
        model: 'Invoice',
      });
  
  
      for (const payment of pendingPayments) {
        const invoice = payment.invoiceId;
        if (!invoice) continue;
  
        const customer = await Customer.findById(invoice.customer);
        if (!customer || !customer.email) continue;
  
        const dueDate = new Date(invoice.dueDate);
        const reminderDate = new Date();
        reminderDate.setDate(reminderDate.getDate() + 2);
  
        if (dueDate <= reminderDate && dueDate >= new Date()) {
          await sendReminderEmail(
            customer.email,
            invoice.invoiceNumber,
            dueDate,
            customer.name || 'Customer'
          );
        }
      }
    } catch (error) {
      console.error('Error processing pending payment reminders:', error);
    }
  };
  

// Schedule the recurring invoice cron job to run daily at midnight (server time)
cron.schedule('0 0 * * *', () => {
    console.log('Cron job started: Send Payment Reminder...');
    sendPendingPaymentReminders();
});







































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































